<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="description" content="Calcolatore di difficoltà per incantesimi - regolamento open source GdR">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpellCheck - Calcolo Difficoltà Incantesimi</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/themes.css">
  </head>
<body>
<header class="text-center mb-4">
  <h1>SpellCheck - Calcolo Difficoltà Incantesimi</h1>
  <img src="assets/img/logo.png" alt="Logo" class="img-fluid" style="max-width:150px" loading="lazy">

  <div class="text-center mt-4">
    <button id="install-button" class="btn btn-custom" style="display:none;">Installa App</button>
	<button id="theme-toggle" class="btn btn-custom" type="button" aria-label="Cambia tema">Tema</button>
	<button id="style-toggle" class="btn btn-custom" type="button" aria-label="Cambia stile">Stile</button>
  </div>

  <!-- Popup Volontà/Grado -->
  <div id="popup-grado-magia" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Inserisci Volontà e Grado di conoscenza della scuola di magia:</h2>

      <div class="text-center mt-4">
        <label for="punteggio-volonta">Mod. Volontà:</label>
        <img src="assets/icons/minus.png" alt="-" class="adjust-icon mx-2" onclick="decrementaVolonta()">
        <input type="number" id="punteggio-volonta" class="form-control mx-auto" min="0" value="0" style="display:inline-block;width:80px;">
        <img src="assets/icons/plus.png" alt="+" class="adjust-icon mx-2" onclick="incrementaVolonta()">
      </div>

      <div class="text-center mt-4">
        <label for="grado-magia">Grado Magia:</label>
        <img src="assets/icons/minus.png" alt="-" class="adjust-icon mx-2" onclick="decrementaGradoMagia()">
        <input type="number" id="grado-magia" class="form-control mx-auto" min="0" value="0" style="display:inline-block;width:80px;">
        <img src="assets/icons/plus.png" alt="+" class="adjust-icon mx-2" onclick="incrementaGradoMagia()">
      </div>

      <div class="text-center mt-4">
        <button id="submit-grado-magia" class="btn btn-custom">OK</button>
      </div>
    </div>
  </div>

  <!-- Popup risultati -->
  <div id="popup-difficolta" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Difficoltà Totale: <span id="difficolta-totale-popup">20</span></h2>

      <div class="popup-row"><label>Lancio dado necessario:</label> <span id="lancio-dado-necessario">0</span></div>
      <div class="popup-row"><label>Fatica accumulata:</label>        <span id="fatica-accumulata">0</span></div>
      <div class="popup-row"><label>Danno Base:</label>               <span id="danno-base">0</span></div>
      <div class="popup-row"><label>Dadi di Danno:</label>            <span id="dadi-danno-riepilogo">Nessun dado</span></div>
      <div class="popup-row"><label>Difficoltà per resistere:</label> <span id="difficolta-resistenza">0</span></div>

      <div class="text-center mt-4"><button id="close-popup" class="btn btn-custom">Chiudi</button></div>
    </div>
  </div>
</header>

<noscript>
  <div class="container"><div class="alert alert-warning">Per utilizzare l’app è necessario abilitare JavaScript.</div></div>
</noscript>

<div class="container">
  <form>
    <!-- Distanza -->
    <div class="mb-3">
      <label for="distanza" class="form-label">A che distanza si trova il bersaglio?</label>
      <select id="distanza" class="form-select"></select>
    </div>

    <!-- Area -->
    <div class="mb-3">
      <label for="area" class="form-label">Quale sarà l'area d'effetto?</label>
      <select id="area" class="form-select" onchange="mostraInputBersagliDiametro()"></select>
    </div>

    <!-- Dinamici area -->
    <div class="mb-3 text-center" id="input-bersagli" style="display:none;">
      <img src="assets/icons/minus.png" alt="-" class="adjust-icon" onclick="decrementaInput('numero-bersagli')">
      <input type="number" id="numero-bersagli" class="form-control mx-auto" min="0" value="1">
      <img src="assets/icons/plus.png" alt="+" class="adjust-icon" onclick="incrementaInput('numero-bersagli')">
    </div>

    <div class="mb-3 text-center" id="input-diametro" style="display:none;">
      <img src="assets/icons/minus.png" alt="-" class="adjust-icon" onclick="decrementaInput('numero-diametro')">
      <input type="number" id="numero-diametro" class="form-control mx-auto" min="0" value="1">
      <img src="assets/icons/plus.png" alt="+" class="adjust-icon" onclick="incrementaInput('numero-diametro')">
    </div>

    <!-- Durata -->
    <div class="mb-3">
      <label for="durata" class="form-label">Durata</label>
      <select id="durata" class="form-select" onchange="mostraInputDurata()"></select>
    </div>

    <!-- Dinamici durata -->
    <div class="mb-3 text-center" id="input-round" style="display:none;">
      <img src="assets/icons/minus.png" alt="-" class="adjust-icon" onclick="decrementaInput('numero-round')">
      <input type="number" id="numero-round" class="form-control mx-auto" min="0" value="1">
      <img src="assets/icons/plus.png" alt="+" class="adjust-icon" onclick="incrementaInput('numero-round')">
    </div>

    <div class="mb-3 text-center" id="input-minuti10" style="display:none;">
      <img src="assets/icons/minus.png" alt="-" class="adjust-icon" onclick="decrementaInput('numero-minuti10')">
      <input type="number" id="numero-minuti10" class="form-control mx-auto" min="0" value="1">
      <img src="assets/icons/plus.png" alt="+" class="adjust-icon" onclick="incrementaInput('numero-minuti10')">
    </div>

    <!-- Modalità di lancio -->
    <h2 class="h4 text-center">Modalità di lancio</h2>

    <div class="mb-3">
      <label for="gesti" class="form-label">Modalità di lancio gestuali</label>
      <select id="gesti" class="form-select"></select>
    </div>

    <div class="mb-3">
      <label for="verbale" class="form-label">Modalità di lancio verbale</label>
      <select id="verbale" class="form-select"></select>
    </div>

    <div class="mb-3">
      <label for="posizione" class="form-label">Modalità di lancio in posizione</label>
      <select id="posizione" class="form-select"></select>
    </div>

    <!-- Variabili -->
    <h2 class="h4 text-center">Variabili di lancio</h2>

    <div class="form-check">
      <input type="checkbox" id="variabile1" class="form-check-input">
      <label for="variabile1" class="form-check-label" id="label-variabile1"></label>
    </div>

    <div class="form-check">
      <input type="checkbox" id="variabile2" class="form-check-input" onchange="mostraInputVariabili()">
      <label for="variabile2" class="form-check-label" id="label-variabile2"></label>
    </div>

    <div class="mb-3 text-center" id="input-mago-aggiuntivo" style="display:none;">
      <img src="assets/icons/minus.png" alt="-" class="adjust-icon" onclick="decrementaMagiAggiuntivi()">
      <input type="number" id="numero-magi-aggiuntivi" class="form-control mx-auto" min="0" value="1" onchange="aggiornaPunteggiMagiAggiuntivi()">
      <img src="assets/icons/plus.png" alt="+" class="adjust-icon" onclick="incrementaMagiAggiuntivi()">
    </div>
    <div id="punteggi-magi-aggiuntivi" class="mb-3 text-center"></div>

    <div class="form-check">
      <input type="checkbox" id="variabile3" class="form-check-input" onchange="mostraInputVariabili()">
      <label for="variabile3" class="form-check-label" id="label-variabile3"></label>
    </div>

    <div class="mb-3 text-center" id="input-lancio-rituale" style="display:none;">
      <img src="assets/icons/minus.png" alt="-" class="adjust-icon" onclick="decrementaInput('numero-rituali')">
      <input type="number" id="numero-rituali" class="form-control mx-auto" min="0" value="1">
      <img src="assets/icons/plus.png" alt="+" class="adjust-icon" onclick="incrementaInput('numero-rituali')">
    </div>

    <div class="form-check">
      <input type="checkbox" id="rounds-checkbox" class="form-check-input" onchange="mostraInputRound()">
      <label for="rounds-checkbox" class="form-check-label" id="label-rounds"></label>
    </div>

    <div class="mb-3 text-center" id="input-rounds" style="display:none;">
      <img src="assets/icons/minus.png" alt="-" class="adjust-icon" onclick="decrementaInput('numero-rounds')">
      <input type="number" id="numero-rounds" class="form-control mx-auto" min="0" max="10" value="1">
      <img src="assets/icons/plus.png" alt="+" class="adjust-icon" onclick="incrementaRoundConcentrazione()">
    </div>

    <!-- Effetti -->
    <h2 class="h4 text-center">Effetti di lancio</h2>
    <div class="form-check">
      <input type="checkbox" id="effetto1" class="form-check-input">
      <label for="effetto1" class="form-check-label" id="label-effetto1"></label>
    </div>
    <div class="form-check">
      <input type="checkbox" id="effetto2" class="form-check-input">
      <label for="effetto2" class="form-check-label" id="label-effetto2"></label>
    </div>
    <div class="form-check">
      <input type="checkbox" id="effetto3" class="form-check-input">
      <label for="effetto3" class="form-check-label" id="label-effetto3"></label>
    </div>

    <!-- Modificatori Scuole -->
    <h2 class="h4 text-center">Modificatori per specifiche Scuole</h2>

    <h3 class="h4">Corpo</h3>
    <div class="form-check">
      <input type="checkbox" id="corpo-checkbox" class="form-check-input" onchange="toggleCorpoDropdown()">
      <label for="corpo-checkbox" class="form-check-label">Abilita modificatori per l'uso di Corpo</label>
    </div>
    <div class="mb-3" id="corpo-dropdown-container" style="display:none;">
      <select id="modificatori_corpo" class="form-select"></select>
    </div>

    <h3 class="h4">Materia</h3>
    <div class="form-check">
      <input type="checkbox" id="materia-checkbox" class="form-check-input" onchange="toggleMateriaDropdown()">
      <label for="materia-checkbox" class="form-check-label">Abilita modificatori per l'uso di Materia</label>
    </div>
    <div class="mb-3" id="materia-dropdown-container" style="display:none;">
      <select id="modificatori_materia" class="form-select"></select>
    </div>

    <h3 class="h4">Mente</h3>
    <div class="form-check">
      <input type="checkbox" id="mente-checkbox" class="form-check-input" onchange="toggleMenteDropdown()">
      <label for="mente-checkbox" class="form-check-label">Abilita modificatori per l'uso di Mente</label>
    </div>
    <div class="mb-3" id="mente-dropdown-container" style="display:none;">
      <select id="modificatori_mente" class="form-select"></select>
    </div>

    <!-- Dadi aggiuntivi -->
    <div class="dadi-aggiuntivi-container text-center">
      <h2 class="h4 text-center">Dadi aggiuntivi</h2>

      <!-- +1 -->
      <div class="mb-3 text-center">
        <img src="assets/icons/minus.png" class="adjust-icon mx-auto" id="minus-d1" onclick="decrementaInput('danni1')" style="display:none;" alt="-">
        <img src="assets/icons/1.png" alt="+1" class="dice-icon" id="toggle-d1" onclick="toggled1()">
        <img src="assets/icons/plus.png" class="adjust-icon mx-auto" id="plus-d1" onclick="incrementaInput('danni1')" style="display:none;" alt="+">
        <label class="form-label d-block" id="label-d1"></label>
        <div id="d1-controls" style="display:none;">
          <input type="number" id="danni1" class="form-control mx-auto" min="0" value="0">
        </div>
      </div>

      <!-- d4 -->
      <div class="mb-3 text-center">
        <img src="assets/icons/minus.png" class="adjust-icon mx-auto" id="minus-d4" onclick="decrementaInput('danni2')" style="display:none;" alt="-">
        <img src="assets/icons/d4.png" alt="d4" class="dice-icon" id="toggle-d4" onclick="toggleD4()">
        <img src="assets/icons/plus.png" class="adjust-icon mx-auto" id="plus-d4" onclick="incrementaInput('danni2')" style="display:none;" alt="+">
        <label class="form-label d-block" id="label-d4"></label>
        <div id="d4-controls" style="display:none;">
          <input type="number" id="danni2" class="form-control mx-auto" min="0" value="0">
        </div>
      </div>

      <!-- d6 -->
      <div class="mb-3 text-center">
        <img src="assets/icons/minus.png" class="adjust-icon mx-auto" id="minus-d6" onclick="decrementaInput('danni3')" style="display:none;" alt="-">
        <img src="assets/icons/d6.png" alt="d6" class="dice-icon" id="toggle-d6" onclick="toggleD6()">
        <img src="assets/icons/plus.png" class="adjust-icon mx-auto" id="plus-d6" onclick="incrementaInput('danni3')" style="display:none;" alt="+">
        <label class="form-label d-block" id="label-d6"></label>
        <div id="d6-controls" style="display:none;">
          <input type="number" id="danni3" class="form-control mx-auto" min="0" value="0">
        </div>
      </div>

      <!-- d8 -->
      <div class="mb-3 text-center">
        <img src="assets/icons/minus.png" class="adjust-icon mx-auto" id="minus-d8" onclick="decrementaInput('danni4')" style="display:none;" alt="-">
        <img src="assets/icons/d8.png" alt="d8" class="dice-icon" id="toggle-d8" onclick="toggleD8()">
        <img src="assets/icons/plus.png" class="adjust-icon mx-auto" id="plus-d8" onclick="incrementaInput('danni4')" style="display:none;" alt="+">
        <label class="form-label d-block" id="label-d8"></label>
        <div id="d8-controls" style="display:none;">
          <input type="number" id="danni4" class="form-control mx-auto" min="0" value="0">
        </div>
      </div>

      <!-- d10 -->
      <div class="mb-3 text-center">
        <img src="assets/icons/minus.png" class="adjust-icon mx-auto" id="minus-d10" onclick="decrementaInput('danni5')" style="display:none;" alt="-">
        <img src="assets/icons/d10.png" alt="d10" class="dice-icon" id="toggle-d10" onclick="toggleD10()">
        <img src="assets/icons/plus.png" class="adjust-icon mx-auto" id="plus-d10" onclick="incrementaInput('danni5')" style="display:none;" alt="+">
        <label class="form-label d-block" id="label-d10"></label>
        <div id="d10-controls" style="display:none;">
          <input type="number" id="danni5" class="form-control mx-auto" min="0" value="0">
        </div>
      </div>

      <!-- d12 -->
      <div class="mb-3 text-center">
        <img src="assets/icons/minus.png" class="adjust-icon mx-auto" id="minus-d12" onclick="decrementaInput('danni6')" style="display:none;" alt="-">
        <img src="assets/icons/d12.png" alt="d12" class="dice-icon" id="toggle-d12" onclick="toggleD12()">
        <img src="assets/icons/plus.png" class="adjust-icon mx-auto" id="plus-d12" onclick="incrementaInput('danni6')" style="display:none;" alt="+">
        <label class="form-label d-block" id="label-d12"></label>
        <div id="d12-controls" style="display:none;">
          <input type="number" id="danni6" class="form-control mx-auto" min="0" value="0">
        </div>
      </div>

      <!-- d20 -->
      <div class="mb-3 text-center">
        <img src="assets/icons/minus.png" class="adjust-icon mx-auto" id="minus-d20" onclick="decrementaInput('danni7')" style="display:none;" alt="-">
        <img src="assets/icons/d20.png" alt="d20" class="dice-icon" id="toggle-d20" onclick="toggleD20()">
        <img src="assets/icons/plus.png" class="adjust-icon mx-auto" id="plus-d20" onclick="incrementaInput('danni7')" style="display:none;" alt="+">
        <label class="form-label d-block" id="label-d20"></label>
        <div id="d20-controls" style="display:none;">
          <input type="number" id="danni7" class="form-control mx-auto" min="0" value="0">
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div class="button-container">
      <button type="button" class="btn btn-custom" onclick="calcolaDifficolta()">Calcola Difficoltà</button>
      <button type="button" class="btn btn-custom" onclick="ripristinaValori()">Reset</button>
    </div>
  </form>
</div>

<footer class="text-center mt-4"><p>&copy; 2024 CrypticSentinel - Open Source GDR - SpellCheck - ver 202508181151</p></footer>

<script src="assets/js/tabelle.js"></script>
<script src="assets/js/script.js"></script>
<script src="assets/js/modal-utils.js"></script>
<script src="assets/js/theme-toggle.js"></script>
<script src="assets/js/style-toggle.js"></script>
<script src="assets/js/pwa-install.js"></script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./service-worker.js');

      // 1) Quando trova un update
      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        if (!newWorker) return;
        newWorker.addEventListener('statechange', () => {
          // 'installed' + esiste un controller => SW aggiornato, app già controllata dal vecchio SW
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // Reload "morbido": evita loop usando un flag
            if (!sessionStorage.getItem('sw-reloaded')) {
              sessionStorage.setItem('sw-reloaded', '1');
              window.location.reload();
            }
          }
        });
      });

      // 2) Fallback: se cambia il controller, ricarica una sola volta
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!sessionStorage.getItem('sw-reloaded')) {
          sessionStorage.setItem('sw-reloaded', '1');
          window.location.reload();
        }
      });
    } catch (e) {
      console.error('SW registration failed:', e);
    }
  });
}
</script>
</body>
</html>